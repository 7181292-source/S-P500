# sp500papertraderhebrew_full.py
import streamlit as st
import yfinance as yf
import pandas as pd
import datetime as dt
import matplotlib.pyplot as plt
import snscrape.modules.twitter as sntwitter
from googletrans import Translator
from textblob import TextBlob

# -----------------------------
# ×”×’×“×¨×•×ª ×¨××©×•× ×™×•×ª ×•×¢×™×¦×•×‘
# -----------------------------
st.set_page_config(page_title="×¡×•×—×¨ ×•×™×¨×˜×•××œ×™ S&P 500", layout="wide")
st.markdown("""
<style>
h1, h2, h3 {
    text-align: center;
    color: #2E86C1;
}
.intro {
    background-color: #F2F3F4;
    padding: 20px;
    border-radius: 10px;
    margin-bottom: 20px;
}
.tab-header {
    font-size: 18px;
    font-weight: bold;
    color: #2E86C1;
}
</style>
""", unsafe_allow_html=True)

st.markdown("""
<div class="intro">
<h2>×‘×¨×•×›×™× ×”×‘××™× ×œ×¡×•×—×¨ ×”×•×•×™×¨×˜×•××œ×™ ×‘××“×“ S&P 500 ğŸ“ˆ</h2>
<p>××¤×œ×™×§×¦×™×” ××™× ×˜×¨××§×˜×™×‘×™×ª ×¢× ×›×¡×£ ××“×•××”, ×’×¨×¤×™×, ×¤×•×–×™×¦×™×•×ª, ×¦×™×•×¦×™×, × ×™×ª×•×— ×¨×’×©×•×ª ×•×”××œ×¦×•×ª ××•×˜×•××˜×™×•×ª!</p>
</div>
""", unsafe_allow_html=True)

translator = Translator()

# -----------------------------
# ××¦×‘ ×¡×©×Ÿ
# -----------------------------
if "×™×ª×¨×”" not in st.session_state:
    st.session_state["×™×ª×¨×”"] = 10000.0
if "×¤×•×–×™×¦×™×•×ª" not in st.session_state:
    st.session_state["×¤×•×–×™×¦×™×•×ª"] = {}
if "×¢×¡×§××•×ª" not in st.session_state:
    st.session_state["×¢×¡×§××•×ª"] = []
if "×”×™×¡×˜×•×¨×™×”" not in st.session_state:
    st.session_state["×”×™×¡×˜×•×¨×™×”"] = None

# -----------------------------
# ×¤×•× ×§×¦×™×•×ª ×¢×–×¨
# -----------------------------
def ×˜×¢×Ÿ_××—×™×¨×™×(×¡×™××•×œ="^GSPC", ×ª×§×•×¤×”="1mo", ××¨×•×•×—="1d"):
    df = yf.download(×¡×™××•×œ, period=×ª×§×•×¤×”, interval=××¨×•×•×—, progress=False)
    if df.empty:
        return None
    df.index = pd.to_datetime(df.index)
    return df[['Open','High','Low','Close','Volume']]

def ××—×™×¨_× ×•×›×—×™(×¡×™××•×œ="^GSPC"):
    df = ×˜×¢×Ÿ_××—×™×¨×™×(×¡×™××•×œ, ×ª×§×•×¤×”="5d")
    if df is None or df.empty:
        return None
    return float(df['Close'].iloc[-1])

def ×§× ×™×™×”(×¡×™××•×œ="^GSPC", ×¡×›×•×=None, ×× ×™×•×ª=None):
    ××—×™×¨ = ××—×™×¨_× ×•×›×—×™(×¡×™××•×œ)
    if ××—×™×¨ is None:
        st.warning("×œ× × ×™×ª×Ÿ ×œ×§×‘×œ ××—×™×¨ ×›×¨×’×¢")
        return
    if ×× ×™×•×ª is None and ×¡×›×•× is not None:
        ×× ×™×•×ª = int(×¡×›×•× // ××—×™×¨)
    if ×× ×™×•×ª is None or ×× ×™×•×ª <= 0:
        st.warning("×›××•×ª ×œ× ××¡×¤×™×§×”")
        return
    ×¢×œ×•×ª = ×× ×™×•×ª * ××—×™×¨
    if ×¢×œ×•×ª > st.session_state["×™×ª×¨×”"]:
        st.warning("××™×Ÿ ××¡×¤×™×§ ×™×ª×¨×”")
        return
    st.session_state["×™×ª×¨×”"] -= ×¢×œ×•×ª
    ×¤×•×–×™×¦×™×” = st.session_state["×¤×•×–×™×¦×™×•×ª"].get(×¡×™××•×œ, {"×× ×™×•×ª":0,"××—×™×¨ ×××•×¦×¢":0.0})
    ×¡×”×› = ×¤×•×–×™×¦×™×”["×× ×™×•×ª"] + ×× ×™×•×ª
    ×××•×¦×¢ = (×¤×•×–×™×¦×™×”["××—×™×¨ ×××•×¦×¢"] * ×¤×•×–×™×¦×™×”["×× ×™×•×ª"] + ××—×™×¨ * ×× ×™×•×ª) / ×¡×”×›
    st.session_state["×¤×•×–×™×¦×™×•×ª"][×¡×™××•×œ] = {"×× ×™×•×ª": ×¡×”×›, "××—×™×¨ ×××•×¦×¢": ×××•×¦×¢}
    st.session_state["×¢×¡×§××•×ª"].append({
        "×–××Ÿ": dt.datetime.utcnow(),
        "×¡×™××•×œ": ×¡×™××•×œ,
        "×¤×¢×•×œ×”": "×§× ×™×™×”",
        "×× ×™×•×ª": ×× ×™×•×ª,
        "××—×™×¨": ××—×™×¨,
        "×™×ª×¨×” ×œ××—×¨": st.session_state["×™×ª×¨×”"]
    })

def ××›×™×¨×”(×¡×™××•×œ="^GSPC", ×× ×™×•×ª=None):
    ××—×™×¨ = ××—×™×¨_× ×•×›×—×™(×¡×™××•×œ)
    ×¤×•×–×™×¦×™×” = st.session_state["×¤×•×–×™×¦×™×•×ª"].get(×¡×™××•×œ)
    if ×¤×•×–×™×¦×™×” is None or ×¤×•×–×™×¦×™×”["×× ×™×•×ª"] <= 0:
        st.warning("××™×Ÿ ×¤×•×–×™×¦×™×” ×œ××›×™×¨×”")
        return
    if ×× ×™×•×ª is None or ×× ×™×•×ª > ×¤×•×–×™×¦×™×”["×× ×™×•×ª"]:
        ×× ×™×•×ª = ×¤×•×–×™×¦×™×”["×× ×™×•×ª"]
    ×”×›× ×¡×” = ×× ×™×•×ª * ××—×™×¨
    st.session_state["×™×ª×¨×”"] += ×”×›× ×¡×”
    ×¤×•×–×™×¦×™×”["×× ×™×•×ª"] -= ×× ×™×•×ª
    if ×¤×•×–×™×¦×™×”["×× ×™×•×ª"] == 0:
        ×¤×•×–×™×¦×™×”["××—×™×¨ ×××•×¦×¢"] = 0.0
    st.session_state["×¤×•×–×™×¦×™×•×ª"][×¡×™××•×œ] = ×¤×•×–×™×¦×™×”
    st.session_state["×¢×¡×§××•×ª"].append({
        "×–××Ÿ": dt.datetime.utcnow(),
        "×¡×™××•×œ": ×¡×™××•×œ,
        "×¤×¢×•×œ×”": "××›×™×¨×”",
        "×× ×™×•×ª": ×× ×™×•×ª,
        "××—×™×¨": ××—×™×¨,
        "×™×ª×¨×” ×œ××—×¨": st.session_state["×™×ª×¨×”"]
    })

def ×”×•×¡×£_×›×¡×£(×¡×›×•×):
    if ×¡×›×•× > 0:
        st.session_state["×™×ª×¨×”"] += ×¡×›×•×
        st.success(f"×”×•×¡×¤×ª ${×¡×›×•×} ×œ×™×ª×¨×” ×‘×”×¦×œ×—×”!")

def ×¦×™×•×¦×™×(×—×™×¤×•×©="S&P 500", ×›××•×ª=30):
    ×¦×™×•×¦×™× = []
    ×ª×•×›×Ÿ_×™×™×—×•×“×™ = set()
    for i, tweet in enumerate(sntwitter.TwitterSearchScraper(×—×™×¤×•×©).get_items()):
        if i >= ×›××•×ª:
            break
        ×˜×§×¡×˜ = tweet.content.strip()
        if ×˜×§×¡×˜ in ×ª×•×›×Ÿ_×™×™×—×•×“×™:
            continue
        ×ª×•×›×Ÿ_×™×™×—×•×“×™.add(×˜×§×¡×˜)
        try:
            ×ª×¨×’×•× = translator.translate(×˜×§×¡×˜, src='en', dest='he').text
        except:
            ×ª×¨×’×•× = "×©×’×™××” ×‘×ª×¨×’×•×"
        ×¨×’×© = TextBlob(×˜×§×¡×˜).sentiment.polarity
        if ×¨×’×© > 0.1:
            ××¦×‘_×¨×’×© = "×—×™×•×‘×™"
        elif ×¨×’×© < -0.1:
            ××¦×‘_×¨×’×© = "×©×œ×™×œ×™"
        else:
            ××¦×‘_×¨×’×© = "× ×™×™×˜×¨×œ×™"
        ×¦×™×•×¦×™×.append({
            "×ª××¨×™×š": tweet.date,
            "×× ×’×œ×™×ª": ×˜×§×¡×˜,
            "×¢×‘×¨×™×ª": ×ª×¨×’×•×,
            "×¨×’×©": ××¦×‘_×¨×’×©
        })
    return pd.DataFrame(×¦×™×•×¦×™×)

def ×”××œ×¦×”_××•×˜×•××˜×™×ª(df_×¦×™×•×¦×™×):
    ×¡×š_×¦×™×•×¦×™× = len(df_×¦×™×•×¦×™×)
    ×—×™×•×‘×™ = sum(df_×¦×™×•×¦×™×["×¨×’×©"] == "×—×™×•×‘×™")
    ×©×œ×™×œ×™ = sum(df_×¦×™×•×¦×™×["×¨×’×©"] == "×©×œ×™×œ×™")
    × ×™×™×˜×¨×œ×™ = ×¡×š_×¦×™×•×¦×™× - ×—×™×•×‘×™ - ×©×œ×™×œ×™
    if ×¡×š_×¦×™×•×¦×™× == 0:
        return "××™×Ÿ ××¡×¤×™×§ ××™×“×¢ ×œ×”××œ×¦×” ×›×¨×’×¢."
    if ×—×™×•×‘×™ > ×©×œ×™×œ×™ and ×—×™×•×‘×™ > × ×™×™×˜×¨×œ×™:
        return f"× ×¨××” ×©×¨×•×‘ ×”×¦×™×•×¦×™× ×—×™×•×‘×™×™× ({×—×™×•×‘×™}/{×¡×š_×¦×™×•×¦×™×}) â€” ×™×™×ª×›×Ÿ ×©×›×“××™ ×œ×©×§×•×œ ×§× ×™×™×”."
    elif ×©×œ×™×œ×™ > ×—×™×•×‘×™ and ×©×œ×™×œ×™ > × ×™×™×˜×¨×œ×™:
        return f"× ×¨××” ×©×¨×•×‘ ×”×¦×™×•×¦×™× ×©×œ×™×œ×™×™× ({×©×œ×™×œ×™}/{×¡×š_×¦×™×•×¦×™×}) â€” ×™×™×ª×›×Ÿ ×©×›×“××™ ×œ×”××ª×™×Ÿ ××• ×œ×©×§×•×œ ××›×™×¨×”."
    else:
        return f"×”×¨×’×©×•×ª ××¢×•×¨×‘×™× ({×—×™×•×‘×™} ×—×™×•×‘×™, {×©×œ×™×œ×™} ×©×œ×™×œ×™, {× ×™×™×˜×¨×œ×™} × ×™×™×˜×¨×œ×™) â€” ××™×Ÿ ×”××œ×¦×” ×‘×¨×•×¨×” ×›×¨×’×¢."

# -----------------------------
# ×××©×§ ×¢× ×˜××‘×™×
# -----------------------------
tabs = st.tabs(["×’×¨×£", "×¤×•×–×™×¦×™×•×ª", "×§× ×™×™×”/××›×™×¨×”", "×¦×™×•×¦×™×"])

# --- ×’×¨×£ ---
with tabs[0]:
    st.header("×’×¨×£ ××—×™×¨×™× ×”×™×¡×˜×•×¨×™")
    ×ª×§×•×¤×” = st.selectbox("×‘×—×¨ ×ª×§×•×¤×ª ×”×™×¡×˜×•×¨×™×”", ["1mo","3mo","6mo"], index=0, key="×’×¨×£")
    if st.button("×˜×¢×Ÿ ×’×¨×£"):
        df = ×˜×¢×Ÿ_××—×™×¨×™×(×ª×§×•×¤×”=×ª×§×•×¤×”)
        if df is None:
            st.warning("×œ× × ××¦××• × ×ª×•× ×™×")
        else:
            st.session_state["×”×™×¡×˜×•×¨×™×”"] = df
            st.success("×”× ×ª×•× ×™× × ×˜×¢× ×•")
    if st.session_state["×”×™×¡×˜×•×¨×™×”"] is not None:
        df = st.session_state["×”×™×¡×˜×•×¨×™×”"]
        fig, ax = plt.subplots(figsize=(10,4))
        ax.plot(df.index, df['Close'], label='××—×™×¨ ×¡×’×™×¨×”', color="#2E86C1")
        ax.set_title("×’×¨×£ S&P 500")
        ax.set_xlabel("×ª××¨×™×š")
        ax.set_ylabel("××—×™×¨")
        ax.grid(True)
        st.pyplot(fig)

# --- ×¤×•×–×™×¦×™×•×ª ---
with tabs[1]:
    st.header("×¤×•×–×™×¦×™×•×ª × ×•×›×—×™×•×ª")
    if st.session_state["×¤×•×–×™×¦×™×•×ª"]:
        for ×¡×™××•×œ, ×¤×•×–×™×¦×™×” in st.session_state["×¤×•×–×™×¦×™×•×ª"].items():
            currentprice = ××—×™×¨_× ×•×›×—×™(×¡×™××•×œ)
            if currentprice:
                ×¨×•×•×—×”×¤×¡×“ = (currentprice - ×¤×•×–×™×¦×™×”["××—×™×¨ ×××•×¦×¢"]) * ×¤×•×–×™×¦×™×”["×× ×™×•×ª"]
            else:
                ×¨×•×•×—×”×¤×¡×“ = 0
            st.write(f"{×¡×™××•×œ}: {×¤×•×–×™×¦×™×”['×× ×™×•×ª']} ×× ×™×•×ª â€” ××—×™×¨ ×××•×¦×¢ ${×¤×•×–×™×¦×™×”['××—×™×¨ ×××•×¦×¢']:.2f} â€” ×¨×•×•×—/×”×¤×¡×“ ${×¨×•×•×—×”×¤×¡×“:,.2f}")
    else:
        st.write("××™×Ÿ ×¤×•×–×™×¦×™×•×ª ×›×¨×’×¢")
    st.metric("×™×ª×¨×” × ×•×›×—×™×ª", f"${st.session_state['×™×ª×¨×”']:,.2f}")

# --- ×§× ×™×™×”/××›×™×¨×” ---
with tabs[2]:
    st.header("×§× ×™×™×” / ××›×™×¨×” ××”×™×¨×”")
    ×¡×›×•××§× ×™×™×” = st.number_input("×§× ×™×™×” ×‘×¡×›×•× ($)", value=1000, step=100)
    if st.button("×‘×¦×¢ ×§× ×™×™×”"):
        ×§× ×™×™×”(×¡×›×•×=×¡×›×•××§× ×™×™×”)
    ×›××•×ª××›×™×¨×” = st.number_input("××›×™×¨×” ×‘×›××•×ª ×× ×™×•×ª", value=0, step=1)
    if st.button("×‘×¦×¢ ××›×™×¨×”"):
        ××›×™×¨×”(×× ×™×•×ª=int(×›××•×ª××›×™×¨×”))
    st.subheader("×”×•×¡×¤×ª ×›×¡×£ ×œ×™×ª×¨×”")
    ×¡×›×•×_×—×“×© = st.number_input("×¡×›×•× ×œ×”×•×¡×¤×” ($)", value=0, step=100)
    if st.button("×”×•×¡×£ ×›×¡×£"):
        ×”×•×¡×£_×›×¡×£(×¡×›×•×_×—×“×©)

# --- ×¦×™×•×¦×™× ---
with tabs[3]:
    st.header("×¦×™×•×¦×™× ×•× ×™×ª×•×— ×¨×’×©×•×ª")
    if st.button("×‘×“×•×§ ×¦×™×•×¦×™×"):
        df_×¦×™×•×¦×™× = ×¦×™×•×¦×™×()
        st.dataframe(df_×¦×™×•×¦×™×)
        st.subheader("×”××œ×¦×” ××•×˜×•××˜×™×ª ×œ×¤×™ ×¨×’×©×•×ª")
        st.info(×”××œ×¦×”_××•×˜×•××˜×™×ª(df_×¦×™×•×¦×™×))